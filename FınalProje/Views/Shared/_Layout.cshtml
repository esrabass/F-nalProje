@using FınalProje.Data
@inject AppDbContext _context

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Zaman Kapsülü</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
        <div class="container">
            <a class="navbar-brand fw-semibold" asp-controller="Home" asp-action="Index">Zaman Kapsülü</a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-3">
                    <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="Index">Ana Sayfa</a></li>
                    <li class="nav-item d-none d-lg-block text-secondary">|</li>

                    <li class="nav-item"><a class="nav-link" asp-controller="Kategori" asp-action="Yonetim">Kategori Yönetimi</a></li>
                    <li class="nav-item d-none d-lg-block text-secondary">|</li>

                    <li class="nav-item"><a class="nav-link" asp-controller="Kapsul" asp-action="Yonetim">Kapsül Yönetimi</a></li>
                    <li class="nav-item d-none d-lg-block text-secondary">|</li>
                    <li class="nav-item"><a class="nav-link" asp-controller="Kullanici" asp-action="Yonetim">Kullanıcı Yönetimi</a></li>

                    <li class="nav-item d-none d-lg-block text-secondary">|</li>
                    <li class="nav-item text-light small">📧 iletisim@zamankapsulu.com</li>
                    <li class="nav-item text-light small">☎ 0537 269 27 54</li>

                    @{
                        var bildirimler = _context.Bildirimler
                        .Where(b => !b.OkunduMu)
                        .OrderByDescending(b => b.Tarih)
                        .ToList();

                        bool okunmamisVarMi = bildirimler.Any(b => !b.OkunduMu);
                    }

                    <li class="nav-item position-relative">
                        <a id="notifBtn" class="nav-link" asp-controller="Bildirim" asp-action="Index">
                            <i class="fas fa-bell text-danger"></i>

                            @if (okunmamisVarMi)
                            {
                                <span id="kirmiziNokta"
                                      class="badge rounded-pill bg-danger"
                                      style="position:absolute; top:0; right:0; width:10px; height:10px; padding:0;">
                                </span>
                            }
                        </a>
                    </li>
                    <li class="nav-item position-relative">
                        <a class="nav-link" href="/Kullanici" title="Kullanıcılar">
                            <i class="fas fa-users text-light"></i>
                        </a>
                    </li>


                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-notifications shadow border-0 py-0"
                            style="width: 320px; max-height: 400px; overflow-y: auto; border-radius: 12px;">
                            <li class="p-2 border-bottom bg-light">
                                <small class="fw-bold text-dark">Bildirimler</small>
                            </li>

                            @if (bildirimler.Any())
                            {
                                foreach (var b in bildirimler)
                                {
                                    <li class="p-3 border-bottom position-relative notification-item" id="bildirim-@b.BildirimID">
                                        <button type="button" class="btn-close"
                                                style="position:absolute; right:10px; top:10px; font-size:10px;"
                                                onclick="bildirimSil(@b.BildirimID)" aria-label="Sil"></button>

                                        <div class="pe-3">
                                            <div style="font-size: 13px; color: #333; font-weight: 600;">@b.Baslik</div>
                                            <div style="font-size: 12px; color: #555;">@b.Mesaj</div>
                                            <div class="mt-1">
                                                <small class="text-muted" style="font-size: 10px;">
                                                    <i class="fa-regular fa-clock"></i> @b.Tarih.ToString("dd.MM.yyyy HH:mm")
                                                </small>
                                            </div>
                                        </div>
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="p-4 text-center text-muted small">Henüz bildirim bulunmuyor.</li>
                            }
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main role="main">
        @RenderBody()
    </main>

    <footer class="bg-dark text-light text-center py-4">
        <div class="container small">© 2026 Zaman Kapsülü • Tüm Hakları Saklıdır</div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
     
        $("#notifBtn").on("click", function () {
            const nokta = $("#kirmiziNokta");
            if (nokta.length) {
                nokta.fadeOut(500, function() { $(this).remove(); });

                
                fetch('/Bildirim/TumunuOkunduYap', { method: 'POST' });
            }
        });

      
        function bildirimSil(id) {
            if (confirm("Bu bildirimi silmek istediğinize emin misiniz?")) {
                $.ajax({
                    url: '/Bildirim/Sil/' + id,
                    type: 'POST',
                    success: function () {
                        $(`#bildirim-${id}`).fadeOut(300, function() {
                            $(this).remove();
                            if ($(".notification-item").length === 0) {
                                $(".dropdown-menu").append('<li class="p-4 text-center text-muted small">Henüz bildirim bulunmuyor.</li>');
                            }
                        });
                    },
                    error: function () {
                        alert("Bildirim silinirken bir hata oluştu.");
                    }
                });
            }
        }
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>